<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Campus Crowd</title>
        <!-- Mobile Device Viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=0.01">
        <!-- External -->
        <link rel="icon" type="image/x-icon" href="/images/uncc.png">
        <link rel="stylesheet" type="text/css" href="/css/main.css">
        <!-- script src="/javascript/script.js"></script -->
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
        <script src="/javascript/external/heatmap.js"></script>
        <script src="/javascript/external/gmaps-heatmap.js"></script>
    </head>
    <body>
        <header>
            <h3>Campus Crowd</h3>
            <div class="tabs">
                <a href="#tab1" class="active">Map</a>
                <a href="#tab2">Locations</a>
            </div>
            <script>
                // Get all tab links
                var tabLinks = document.querySelectorAll('.tabs a');
                
                // Add an event listener to each tab link
                tabLinks.forEach(function(tabLink) {
                    tabLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove the active class from all tab links
                    tabLinks.forEach(function(tabLink) {
                        tabLink.classList.remove('active');
                    });
                    
                    // Add the active class to the clicked tab link
                    this.classList.add('active');
                    
                    // Get the tab content
                    var tabContent = document.querySelector(this.hash);
                    
                    // Hide all tab content
                    var tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(function(tabContent) {
                        tabContent.style.display = 'none';
                    });
                    
                    // Show the clicked tab content
                    tabContent.style.display = 'block';
                    });
                });
            </script>
        </header>
        <main> <div id="subBar" class="timeButtonsBar">
                <button class="timeButton" id="0">1 AM</button>
                <button  class="timeButton"  id="1">2 AM</button>
                <button  class="timeButton"  id="3">3 AM</button>
                <button  class="timeButton"  id="4">4 AM</button>
                <button  class="timeButton"  id="5">5 AM</button>
                <button  class="timeButton"  type="button">6 AM</button>
                <button  class="timeButton"  type="button">7 AM</button>
                <button  class="timeButton"  type="button">8 AM</button>
                <button  class="timeButton"  type="button">9 AM</button>
                <button  class="timeButton"  type="button">10 AM</button>
                <button  class="timeButton"  type="button">11 AM</button>
                <button  class="timeButton"  type="button">12 PM</button>
                <button  class="timeButton"  type="button">1 PM</button>
                <button  class="timeButton"  type="button">2 PM</button>
                <button  class="timeButton"  type="button">3 PM</button>
                <button  class="timeButton"  type="button">4 PM</button>
                <button  class="timeButton"  type="button">5 PM</button>
                <button  class="timeButton"  type="button">6 PM</button>
                <button  class="timeButton"  type="button">7 PM</button>
                <button  class="timeButton"  type="button">8 PM</button>
                <button  class="timeButton"  type="button">9 PM</button>
                <button  class="timeButton"  type="button">10 PM</button>
                <button  class="timeButton"  type="button">11 PM</button>
                <button  class="timeButton"  type="button">12 AM</button>
            </div>
            <div id="tab1" class="tab-content">
                <p class="note">Note: The data represented is calculated by number of connections to school wifi, not amount of people in a particular building.</p>
                <div id="map"></div>
            </div>

            <script>
                <%
                let str = JSON_weight.substring(1).slice(0, -1);
                const arr = str.split(",");
                const obj = JSON.parse(JSON_weight);
                let k = []; // locations
                let names = []; // names
                let v = []; // connections
                let lat = []; // latitude
                let lng = []; // longitude
                let reK = /^[^:]+:\s*/g; // regex for chars before colon
                let reV = /:(.*)/g; // regex for chars after colon
                // generate locations and connections

                for (let i=0; i < obj; i++){
                    let str = arr[i];
                    let _newK = str.match(reK);
                    let fK = _newK.toString().substring(1).slice(0, -2);
                    k.push(fK);
                    let _newV = str.match(reV);
                    let fV = _newV.toString().substring(1);
                    v.push(fV);
                }


                let objStr = JSON.stringify(obj);
                let locStr = JSON.stringify(locations);
                %>
                    let options = {zoom: 15.5, center: new google.maps.LatLng(35.3081, -80.7343)}; // map options
                        map = new google.maps.Map(document.getElementById("map"), options); // create new map
                        let wifiData = {};
                        // generate heatmap (credit to heatmap.js on github https://github.com/pa7/heatmap.js)
                        heatmap = new HeatmapOverlay(map,
                        {
                            "radius": 0.0002,
                            "maxOpacity": 0.6,
                            "scaleRadius": true,
                            "useLocalExtrema": false,
                            latField: 'lat',
                            lngField: 'lng',
                            valueField: 'weight'
                        }
                        );
                    var whichButton = {button: "0"};
                    var obj = <%- objStr -%>;
                    var locations = <%- locStr -%>;
                    var location_names = Object.keys(locations);
                    var v = [];
                    var names = [];
                    var lat = [];
                    var lng = [];

                    for(let i = 0; i < Object.keys(obj[whichButton.button][0]).length; i++){
                        v.push(obj[whichButton.button][0][i]);
                        const location = locations[location_names[i]];
                        if (location) {
                            names.push(location.name);
                            lat.push(location.lat);
                            lng.push(location.lng);
                        }
                    }
                    console.log(whichButton.button);


                    let max = Math.max(...v);

                    // generate data to be passed into setData()
                    var data = [];
                    for (let i =0; i < Object.keys(obj[whichButton.button][0]).length; i++){
                        let obj1 = {lat: lat[i], lng: lng[i], weight: v[i]};
                        data.push(obj1);
                    }
                    wifiData = {
                        max: max,
                        data: data
                    };

                    function setButton(btn){
                        whichButton.button = btn;
                    }

                    const zeroE = document.getElementById('0');
                    zeroE.addEventListener('click', (event) => {
                        whichButton.button = event.target.id;
                    })

                    heatmap.setData(wifiData);

                </script>


            <div id="tab2" class="tab-content" style="display: none;">
                 <p class="note">Note: The data represented is calculated by number of connections to school wifi, not amount of people in a particular building.</p>

            <input type="search" id="search" name="search" placeholder="Search Locations" class="searchBar">


                <script>
                    var searchInput = document.getElementById('search');
                    var searchQuery;

                    searchInput.addEventListener('keyup', doSearch);
                        
                    function doSearch() {
                        searchQuery = searchInput.value;
                        filterTable();
                    }
                    
                    function filterTable() {
                        var table = document.getElementById("data");
                        var rows = table.getElementsByTagName("tr");

                        for (var i = 0; i < rows.length; i++) {
                            var nameCell = rows[i].getElementsByTagName("td")[0];
                            if (nameCell) {
                                if (nameCell.innerHTML.toLowerCase().indexOf(searchQuery.toLowerCase()) > -1) {
                                    rows[i].style.display = "";
                                } else {
                                    rows[i].style.display = "none";
                                }
                            }
                        }
                    }
                </script>
                <table id="data">
                    <tr>
                        <th>Location</th>
                        <th>Connections</th>
                    </tr>
                    <!-- populate table with data -->
                    <% for (let i = 0; i < arr.length; i++) {
                    if(v[i] >= 10000) { %>
                        <tr>
                            <td class = "red"><% names[i]%></td>
                            <td class="red"><%v[i]%></td>
                        </tr>
                    <% }
                    if(v[i]>= 1000 && v[i] < 10000) {%>
                        <tr>
                            <td class = "yellow"><%= names[i]%></td>
                            <td class="yellow"><%= v[i]%></td>
                        </tr>
                    <% } if(v[i] < 1000) {%>
                        <tr>
                            <td class = "green"><%= names[i]%></td>
                            <td class="green"><%= v[i]%></td>
                        </tr>
                    <% }
                    } %>

                </table>
            </div>
        </main>
        <footer>
            <p>ITSC 4155 Capstone Project - Group 15</p>
        </footer>
    </body>
</html>